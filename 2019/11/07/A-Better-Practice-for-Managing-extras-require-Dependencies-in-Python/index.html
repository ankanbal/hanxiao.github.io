<!DOCTYPE html><html lang="en"><style>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,header,main{display:block}a{background-color:transparent}h1{font-size:2em;margin:.67em 0}img{border:0}body,html{width:100%;height:100%}body{margin:0;color:#34495e;font-size:18px;line-height:1.6;background-color:#fff;font-family:sourcesanspro,'Helvetica Neue',Arial,sans-serif}ul.nav{margin:0;padding:0;list-style-type:none}ul{margin:1rem 0}a{color:#2c3e50;text-decoration:none}.flag-icon{height:25px;width:25px;display:inline;border-radius:50%;vertical-align:sub}.icon_item{padding-left:5px!important;padding-right:5px!important}header{min-height:60px}header .logo-link{float:left}header .nav{float:right;left:80px}header .logo-link img{height:60px}header .nav-list-item{display:inline-block;padding:19px 10px}header .nav-list-item a{line-height:1.4}@media screen and (max-width:900px){header .nav-list-item a{font-size:15px}}@media screen and (min-width:900px){header .nav-list-item a{font-size:18px}}.post{padding-top:1em}.post-block .post-title{margin:.65em 0;color:#2c3e50;font-size:1.5em}.post-block .post-info{color:#7f8c8d}.post-block .post-info .read-time{text-align:right}.post-content h2,.post-content h4{position:relative;margin:1em 0}.post-content h2 :before,.post-content h4 :before{content:"#";color:#42b983;position:absolute;left:-.7em;top:-4px;font-size:1.2em;font-weight:700}.post-content h4 :before{content:">"}.post-content h2{font-size:22px}.post-content h4{font-size:18px}.post-content a{color:#42b983;word-break:break-all}main.container{margin:2em 10px}@media screen and (min-width:900px){.wrap{width:900px;margin:0 auto}header{padding:20px 60px}}@media screen and (max-width:900px){.wrap{width:100%}header{min-height:50px;padding:2px 2px;position:fixed;z-index:10000;border-radius:15px;left:50%;-webkit-transform:translateX(-50%);transform:translateX(-50%);width:-webkit-fit-content;width:-moz-fit-content;width:fit-content}header a.logo-link,header ul.nav.nav-list{float:none;display:inline;text-align:center}header li.nav-list-item{padding:10px 5px}header .logo-link img{height:20px;vertical-align:sub}header .flag-icon{height:20px;width:20px}header{background-color:rgba(255,255,255,.9)}@supports ((-webkit-backdrop-filter:blur(2em)) or (backdrop-filter:blur(2em))){header{background-color:rgba(255,255,255,.3);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}}main.container{padding-top:2em}main.container{margin:0 20px}.post-content h2,.post-content h4{max-width:300px;left:15px}}@font-face{font-family:sourcesanspro;src:url(/font/sourcesanspro.woff2) format("woff2"),url(/font/sourcesanspro.woff) format("woff");font-weight:400;font-style:normal}</style><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>A Better Practice for Managing Many extras_require Dependencies in Python · Han Xiao Tech Blog - Neural Search, AI, Engineering</title><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@hxiao"><meta name="twitter:creator" content="@hxiao"><meta name="description" content="One problem I was facing when building GNES: Generic Neural Elastic Search is how to effectively control the dependencies in Python. The main dependen ... · Han Xiao"><meta property="og:title" content="A Better Practice for Managing Many extras_require Dependencies in Python · Han Xiao Tech Blog - Neural Search, AI, Engineering"><meta property="og:description" content="One problem I was facing when building GNES: Generic Neural Elastic Search is how to effectively control the dependencies in Python. The main dependen ... · Han Xiao"><meta property="og:url" content="https://hanxiao.io/2019/11/07/A-Better-Practice-for-Managing-extras-require-Dependencies-in-Python/"><meta property="og:image" content="https://hanxiao.io/2019/11/07/A-Better-Practice-for-Managing-extras-require-Dependencies-in-Python//banner.png"><meta property="og:type" content="article"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/wechaticon.png"><link rel="alternate" type="application/rss+xml" title="Han Xiao Tech Blog - Neural Search, AI, Engineering" href="https://hanxiao.io/atom.xml"><link rel="preload" href="/css/apollo.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="/css/apollo.css"></noscript><script>!function(n){"use strict";n.loadCSS||(n.loadCSS=function(){});var o=loadCSS.relpreload={};if(o.support=function(){var e;try{e=n.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),o.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},o.poly=function(){if(!o.support())for(var t=n.document.getElementsByTagName("link"),e=0;e<t.length;e++){var a=t[e];"preload"!==a.rel||"style"!==a.getAttribute("as")||a.getAttribute("data-loadcss")||(a.setAttribute("data-loadcss",!0),o.bindMediaToggle(a))}},!o.support()){o.poly();var t=n.setInterval(o.poly,500);n.addEventListener?n.addEventListener("load",function(){o.poly(),n.clearInterval(t)}):n.attachEvent&&n.attachEvent("onload",function(){o.poly(),n.clearInterval(t)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:n.loadCSS=loadCSS}("undefined"!=typeof global?global:this)</script><link rel="search" type="application/opensearchdescription+xml" href="https://hanxiao.io/atom.xml" title="Han Xiao Tech Blog - Neural Search, AI, Engineering"></head><body><div class="reading-progress-bar"></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/wechaticon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/subscribe/" target="_self" class="nav-list-link">SUBSCRIBE</a></li><li class="nav-list-item icon_item"><a href="https://www.linkedin.com/in/hxiao87" target="_blank" class="nav-list-link"><img src="/linkedin.svg" alt="linkedin" class="flag-icon"></a></li><li class="nav-list-item icon_item"><a href="https://twitter.com/hxiao" target="_blank" class="nav-list-link"><img src="/twitter.svg" alt="twitter" class="flag-icon"></a></li><li class="nav-list-item icon_item"><a href="https://github.com/hanxiao" target="_blank" class="nav-list-link"><img src="/github.svg" alt="github" class="flag-icon"></a></li><li class="nav-list-item icon_item"><a href="https://www.youtube.com/c/jina-ai" target="_blank" class="nav-list-link"><img src="/youtube.svg" alt="youtube" class="flag-icon"></a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">A Better Practice for Managing Many <code>extras_require</code> Dependencies in Python</h1><div class="post-info">Nov 7, 2019 by &nbsp;&nbsp;&nbsp;<img src="/myavatar.png" alt="logo" width="18px" height="18px" style="vertical-align:sub">&nbsp;<a href="/about" target="_blank" class="nav-list-link">Han Xiao - <i>ex</i> Engineering Lead @ Tencent AI Lab</a></div><div class="post-info"><div class="read-time">◷&nbsp;&nbsp;&nbsp; 8 min read</div></div><div class="post-content"><h2><span id="background">Background</span></h2><p>One problem I was facing when building <a href="https://github.com/gnes-ai/gnes/" target="_blank" rel="noopener">GNES: Generic Neural Elastic Search</a> is how to effectively control the dependencies in Python. The main dependencies of GNES is very simple: <code>numpy</code>, <code>grpcio</code>, <code>pyzmq</code> and a YAML parser. But this only runs a vanilla GNES with no fancy deep learning models nor preprocessors.<a id="more"></a> As GNES aims to provide a generic solution for multi-modality semantic search, it often requires extra packages from different domains, such as NLP and CV. Apparently, these optional dependencies are not required for all uses of GNES: people who use GPT2 as text encoder may require <code>pytorch-transformer</code> but not <code>opencv</code> and Tensorflow. We already know that <code>setuptools</code> provides a <code>extras_require</code> field that allows you to <a href="https://setuptools.readthedocs.io/en/latest/setuptools.html#declaring-extras-optional-features-with-their-own-dependencies" target="_blank" rel="noopener">define those plugin-like dependencies</a> as following:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setup(</span><br><span class="line">    name=<span class="string">'GNES'</span>,</span><br><span class="line">    ...</span><br><span class="line">    extras_require=&#123;</span><br><span class="line">        <span class="string">'bert'</span>: [<span class="string">'bert-serving-server&gt;=1.8.6'</span>, <span class="string">'bert-serving-client&gt;=1.8.6'</span>, <span class="string">'pytorch-transformer'</span>, <span class="string">'flair'</span>],</span><br><span class="line">        <span class="string">'vision'</span>: [<span class="string">'opencv-python&gt;=4.0.0'</span>, <span class="string">'imagehash&gt;=4.0'</span>, <span class="string">'image'</span>, <span class="string">'peakutils'</span>],</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p></p><p>This allows one to later cherry-pick the feature via <code>pip install gnes[bert]</code>. However, in practice I found difficult to maintain this feature map as it grows due to the following problems:</p><ul><li>a package can enable multiple features, but I don’t want to copy-paste the same string <code>opencv-python&gt;=4.0.0</code> to everywhere;</li><li>the same feature can be enabled by different packages, but often users only install the one <em>they</em> preferred. See <code>bert</code> in the last example;</li><li>it is not straightforward to see which features a package enabled and what consequences if this package is broken/removed/badly-licensed;</li><li>unable to install all dependencies via <code>pip install gnes[all]</code>;</li><li>hardcoding this big map in <code>setup.py</code> is cumbersome. By decoupling them I can version-control each one better.</li></ul><p>Anyhow, if you dislike something, you always find thousands of reasons to dislike it.</p><h2><span id="solution-build-an-inverted-index">Solution: Build an “Inverted Index”</span></h2><p>The solution that I figured out is simple but effective: maintain a <em>package-to-feature</em> map in a separate plain text file, then parse it to an <em>inverted</em> map in <code>setup.py</code>. So inverted index, kind of. For example, my <a href="https://github.com/hanxiao/gnes/blob/master/extra-requirements.txt" target="_blank" rel="noopener"><code>extra-requirements.txt</code> looks like the following</a>:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># FORMAT</span><br><span class="line"># Put your extra requirements here in the following format</span><br><span class="line">#</span><br><span class="line"># package[version_required]: tag1, tag2, ...</span><br><span class="line"></span><br><span class="line">bert-serving-server&gt;=1.8.6: bert, nlp, encode</span><br><span class="line">bert-serving-client&gt;=1.8.6: bert, nlp, encode</span><br><span class="line">flair&gt;=0.4.1:               nlp, bert, encode</span><br><span class="line">annoy==1.15.2:              index</span><br><span class="line">jieba:                      chinese, nlp</span><br><span class="line">opencv-python&gt;=4.0.0:       cv, prep</span><br><span class="line">imagehash&gt;=4.0:             cv</span><br><span class="line">image:                      cv</span><br><span class="line">peakutils:                  cv</span><br><span class="line">plyvel&gt;=1.0.5:              index</span><br><span class="line">pylint:                     test</span><br><span class="line">memory_profiler&gt;=0.55.0:    test</span><br><span class="line">psutil&gt;=5.6.1:              test</span><br><span class="line">gputil&gt;=1.4.0:              gpu</span><br><span class="line">pytorch-transformers:       nlp, bert, encode</span><br><span class="line">onnxruntime:                encode, ml</span><br><span class="line">librosa&gt;=0.7.0:             audio</span><br><span class="line">scipy:                      numeric</span><br><span class="line">sklearn:                    ml</span><br><span class="line">flask:                      http</span><br><span class="line">aiohttp:                    http</span><br></pre></td></tr></table></figure><p></p><div class="quiz"><br>If you work with an open governance model, you may want to set up some guidelines in <code>CONTRIBUTING</code> about the feature tags, so that other contributors can follow, e.g.:<br><ul><br><li>always reuse the existing feature tags if possible;</li><br><li>when create a new tag, keep it alphabetical, short and general;</li><br><li>tag order does not matter, and duplicated tag will be ignored.</li><br></ul><br></div><p>Now here is my parser to “invert” this map into the format that <code>extras_require</code> needs:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this function should be put in 'setup.py'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_extra_requires</span><span class="params">(path, add_all=True)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line">    <span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(path) <span class="keyword">as</span> fp:</span><br><span class="line">        extra_deps = defaultdict(set)</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> fp:</span><br><span class="line">            <span class="keyword">if</span> k.strip() <span class="keyword">and</span> <span class="keyword">not</span> k.startswith(<span class="string">'#'</span>):</span><br><span class="line">                tags = set()</span><br><span class="line">                <span class="keyword">if</span> <span class="string">':'</span> <span class="keyword">in</span> k:</span><br><span class="line">                    k, v = k.split(<span class="string">':'</span>)</span><br><span class="line">                    tags.update(vv.strip() <span class="keyword">for</span> vv <span class="keyword">in</span> v.split(<span class="string">','</span>))</span><br><span class="line">                tags.add(re.split(<span class="string">'[&lt;=&gt;]'</span>, k)[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">for</span> t <span class="keyword">in</span> tags:</span><br><span class="line">                    extra_deps[t].add(k)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add tag `all` at the end</span></span><br><span class="line">        <span class="keyword">if</span> add_all:</span><br><span class="line">            extra_deps[<span class="string">'all'</span>] = set(vv <span class="keyword">for</span> v <span class="keyword">in</span> extra_deps.values() <span class="keyword">for</span> vv <span class="keyword">in</span> v)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> extra_deps</span><br></pre></td></tr></table></figure><p>, which returns a map as follows:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bert: &#123;&apos;pytorch-transformers&apos;, &apos;flair&gt;=0.4.1&apos;, &apos;bert-serving-server&gt;=1.8.6&apos;, &apos;bert-serving-client&gt;=1.8.6&apos;&#125;</span><br><span class="line">nlp: &#123;&apos;flair&gt;=0.4.1&apos;, &apos;bert-serving-server&gt;=1.8.6&apos;, &apos;jieba&apos;, &apos;pytorch-transformers&apos;, &apos;bert-serving-client&gt;=1.8.6&apos;&#125;</span><br><span class="line">bert-serving-server: &#123;&apos;bert-serving-server&gt;=1.8.6&apos;&#125;</span><br><span class="line">encode: &#123;&apos;onnxruntime&apos;, &apos;flair&gt;=0.4.1&apos;, &apos;bert-serving-server&gt;=1.8.6&apos;, &apos;pytorch-transformers&apos;, &apos;bert-serving-client&gt;=1.8.6&apos;&#125;</span><br><span class="line">...</span><br><span class="line">all: &#123;&apos;onnxruntime&apos;, &apos;annoy==1.15.2&apos;, &apos;imagehash&gt;=4.0&apos;, &apos;psutil&gt;=5.6.1&apos;, &apos;librosa&gt;=0.7.0&apos;, &apos;sklearn&apos;, &apos;aiohttp&apos;, &apos;pytorch-transformers&apos;, &apos;peakutils&apos;, &apos;image&apos;, &apos;pylint&apos;, &apos;bert-serving-server&gt;=1.8.6&apos;, &apos;gputil&gt;=1.4.0&apos;, &apos;bert-serving-client&gt;=1.8.6&apos;, &apos;scipy&apos;, &apos;flair&gt;=0.4.1&apos;, &apos;flask&apos;, &apos;memory_profiler&gt;=0.55.0&apos;, &apos;opencv-python&gt;=4.0.0&apos;, &apos;jieba&apos;, &apos;plyvel&gt;=1.0.5&apos;&#125;</span><br></pre></td></tr></table></figure><p>A nice thing about this solution is that you can add sophisticated logic in the parse function to enable fancy features. In this example, I use the canonical package name as the feature tag (e.g. <code>annoy: [annoy==1.15.2]</code>), and add tag <code>all</code> to allow a full installation via <code>pip install .[all]</code>. You can also add logic to improve granularity of the tags, or introduce hierarchies to them. Just remember to assign it to <code>extras_require</code> in your <code>setup</code> construct:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setup(</span><br><span class="line">    name=<span class="string">'GNES'</span>,</span><br><span class="line">    ...</span><br><span class="line">    extras_require=get_extra_requires(<span class="string">'extra-requirements.txt'</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p></p><p>The complete example <a href="https://github.com/hanxiao/gnes" target="_blank" rel="noopener">can be found here</a>.</p><h2><span id="conclusion">Conclusion</span></h2><p>In this article, I introduce a simple yet effective solution to manage optional dependencies via <code>extras_require</code> in Python. This method is particularly useful when you have too many optional dependencies and you want users to install them as plugins or on-demand features. Comparing to the traditional method where we hardcode a big feature map in <code>setup.py</code>, this method is more readable and easier to maintain.</p><p>Managing a readable <code>setuptools</code> script is probably not on the priority list of every (or <em>any</em>?) AI engineer, still I think it is a nice little trick to keep in mind and make life a bit easier. I’m not going to call it <em>the best practice</em> because that would be way ambitious. So a better practice it is (than <a href="https://setuptools.readthedocs.io/en/latest/setuptools.html#declaring-extras-optional-features-with-their-own-dependencies" target="_blank" rel="noopener">what described in the documentation</a>).</p><p>That said, in GNES we actually have a more sustainable way to manage AI model dependencies via Docker containers, including required Python packages, deep learning framework, pretrained models, hyperparameters and GPU drivers. Everything is wrapped in one container, and the model developers enjoys the full autonomy. This concept is what I called <a href="/2019/07/29/Generic-Neural-Elastic-Search-From-bert-as-service-and-Go-Way-Beyond/#model-as-docker-and-docker-as-a-plugin"><em>Model as Docker, and Docker as a Plugin</em></a>. Interested readers are recommended to checkout <a href="https://github.com/gnes-ai/hub" target="_blank" rel="noopener">GNES Hub</a> and find out how to use it in GNES.</p><img src="/2019/11/07/A-Better-Practice-for-Managing-extras-require-Dependencies-in-Python/4fae4a63.png" title="Model as Docker, and Docker as a Plugin"></div></article></div></main><footer><div class="paginator"><a href="/2019/11/22/Video-Semantic-Search-in-Large-Scale-using-GNES-and-TF-2-0/" class="prev">&nbsp;❮&nbsp;&nbsp;Video Semantic Searc...</a><a href="/2019/11/05/站在世界舞台上看开源-我在国际AI开源基金会当董事/" class="next">站在世界舞台上看开源 - 我在国际AI开...&nbsp;&nbsp;❯&nbsp;</a></div><div id="gitment_thread"></div><div class="copyright"><p>© 2017 - 2020 <a href="https://hanxiao.io">Han Xiao</a>. Opinions are solely my own. <img src="/by-nc-sa.svg" alt="Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License." class="image"></p></div></footer></div><link rel="stylesheet" href="/css/post/katex.min.css"><link rel="stylesheet" href="/css/post/gitment.css"><script src="/js/katex.min.js"></script><script src="/js/auto-render.min.js"></script><script>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})</script><script src="/js/gitment.browser.js"></script><script src="/js/gitment.loader.js"></script><script src="/js/jquery-3.4.1.min.js"></script><script src="/js/reading_progress.min.js"></script><script async src="https://www.google-analytics.com/analytics.js"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-52114253-1","auto"),ga("send","pageview")</script></body></html>