<!DOCTYPE html><html lang="en"><style>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,header,main{display:block}a{background-color:transparent}h1{font-size:2em;margin:.67em 0}img{border:0}body,html{width:100%;height:100%}body{margin:0;color:#34495e;font-size:18px;line-height:1.6;background-color:#fff;font-family:sourcesanspro,'Helvetica Neue',Arial,sans-serif}ul.nav{margin:0;padding:0;list-style-type:none}ul{margin:1rem 0}a{color:#2c3e50;text-decoration:none}.flag-icon{height:25px;width:25px;display:inline;border-radius:50%;vertical-align:sub}.icon_item{padding-left:5px!important;padding-right:5px!important}header{min-height:60px}header .logo-link{float:left}header .nav{float:right;left:80px}header .logo-link img{height:60px}header .nav-list-item{display:inline-block;padding:19px 10px}header .nav-list-item a{line-height:1.4}@media screen and (max-width:900px){header .nav-list-item a{font-size:15px}}@media screen and (min-width:900px){header .nav-list-item a{font-size:18px}}.post{padding-top:1em}.post-block .post-title{margin:.65em 0;color:#2c3e50;font-size:1.5em}.post-block .post-info{color:#7f8c8d}.post-block .post-info .read-time{text-align:right}.post-content h2,.post-content h4{position:relative;margin:1em 0}.post-content h2 :before,.post-content h4 :before{content:"#";color:#42b983;position:absolute;left:-.7em;top:-4px;font-size:1.2em;font-weight:700}.post-content h4 :before{content:">"}.post-content h2{font-size:22px}.post-content h4{font-size:18px}.post-content a{color:#42b983;word-break:break-all}main.container{margin:2em 10px}@media screen and (min-width:900px){.wrap{width:900px;margin:0 auto}header{padding:20px 60px}}@media screen and (max-width:900px){.wrap{width:100%}header{min-height:50px;padding:2px 2px;position:fixed;z-index:10000;border-radius:15px;left:50%;-webkit-transform:translateX(-50%);transform:translateX(-50%);width:-webkit-fit-content;width:-moz-fit-content;width:fit-content}header a.logo-link,header ul.nav.nav-list{float:none;display:inline;text-align:center}header li.nav-list-item{padding:10px 5px}header .logo-link img{height:20px;vertical-align:sub}header .flag-icon{height:20px;width:20px}header{background-color:rgba(255,255,255,.9)}@supports ((-webkit-backdrop-filter:blur(2em)) or (backdrop-filter:blur(2em))){header{background-color:rgba(255,255,255,.3);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}}main.container{padding-top:2em}main.container{margin:0 20px}.post-content h2,.post-content h4{max-width:300px;left:15px}}@font-face{font-family:sourcesanspro;src:url(/font/sourcesanspro.woff2) format("woff2"),url(/font/sourcesanspro.woff) format("woff");font-weight:400;font-style:normal}</style><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Use HParams and YAML to Better Manage Hyperparameters in Tensorflow · Han Xiao Tech Blog - Neural Search, AI, Engineering</title><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@hxiao"><meta name="twitter:creator" content="@hxiao"><meta name="description" content="Building a machine learning system is an exploration-exploitation process. First, you explore some models, network architectures to check which one be ... · Han Xiao"><meta property="og:title" content="Use HParams and YAML to Better Manage Hyperparameters in Tensorflow · Han Xiao Tech Blog - Neural Search, AI, Engineering"><meta property="og:description" content="Building a machine learning system is an exploration-exploitation process. First, you explore some models, network architectures to check which one be ... · Han Xiao"><meta property="og:url" content="https://hanxiao.io/2017/12/21/Use-HParams-and-YAML-to-Better-Manage-Hyperparameters-in-Tensorflow/"><meta property="og:image" content="https://hanxiao.io/2017/12/21/Use-HParams-and-YAML-to-Better-Manage-Hyperparameters-in-Tensorflow//85ddf919.png"><meta property="og:type" content="article"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/wechaticon.png"><link rel="alternate" type="application/rss+xml" title="Han Xiao Tech Blog - Neural Search, AI, Engineering" href="https://hanxiao.io/atom.xml"><link rel="preload" href="/css/apollo.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="/css/apollo.css"></noscript><script>!function(n){"use strict";n.loadCSS||(n.loadCSS=function(){});var o=loadCSS.relpreload={};if(o.support=function(){var e;try{e=n.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),o.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},o.poly=function(){if(!o.support())for(var t=n.document.getElementsByTagName("link"),e=0;e<t.length;e++){var a=t[e];"preload"!==a.rel||"style"!==a.getAttribute("as")||a.getAttribute("data-loadcss")||(a.setAttribute("data-loadcss",!0),o.bindMediaToggle(a))}},!o.support()){o.poly();var t=n.setInterval(o.poly,500);n.addEventListener?n.addEventListener("load",function(){o.poly(),n.clearInterval(t)}):n.attachEvent&&n.attachEvent("onload",function(){o.poly(),n.clearInterval(t)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:n.loadCSS=loadCSS}("undefined"!=typeof global?global:this)</script><link rel="search" type="application/opensearchdescription+xml" href="https://hanxiao.io/atom.xml" title="Han Xiao Tech Blog - Neural Search, AI, Engineering"></head><body><div class="reading-progress-bar"></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/wechaticon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/subscribe/" target="_self" class="nav-list-link">SUBSCRIBE</a></li><li class="nav-list-item icon_item"><a href="https://www.linkedin.com/in/hxiao87" target="_blank" class="nav-list-link"><img src="/linkedin.svg" alt="linkedin" class="flag-icon"></a></li><li class="nav-list-item icon_item"><a href="https://twitter.com/hxiao" target="_blank" class="nav-list-link"><img src="/twitter.svg" alt="twitter" class="flag-icon"></a></li><li class="nav-list-item icon_item"><a href="https://github.com/hanxiao" target="_blank" class="nav-list-link"><img src="/github.svg" alt="github" class="flag-icon"></a></li><li class="nav-list-item icon_item"><a href="https://www.youtube.com/c/jina-ai" target="_blank" class="nav-list-link"><img src="/youtube.svg" alt="youtube" class="flag-icon"></a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Use <code>HParams</code> and YAML to Better Manage Hyperparameters in Tensorflow</h1><div class="post-info">Dec 21, 2017 by &nbsp;&nbsp;&nbsp;<img src="/myavatar.png" alt="logo" width="18px" height="18px" style="vertical-align:sub">&nbsp;<a href="/about" target="_blank" class="nav-list-link">Han Xiao - <i>ex</i> Senior Research Scientist @ Zalando Research</a></div><div class="post-info"><div class="read-time">◷&nbsp;&nbsp;&nbsp; 7 min read</div></div><div class="post-content"><h2><span id="background">Background</span></h2><p>Building a machine learning system is an exploration-exploitation process. First, you explore some models, network architectures to check which one better fits the given problem. Once you have an idea, you concentrate on a particular model and exploit it by (manually/automatically) tuning its hyperparameters. Finally, the winner model with the best parameters will be deployed online to serve real customers. The whole process involves <em>repetitively</em> switching between different contexts and environments: e.g. training, validating and testing; local and remote; CPU, GPU, multi-GPU. As a consequence, how to effectively manage the<a id="more"></a> configuration as well as the model hyperparameters becomes important. A good practice will definitely boost your exploration-exploitation process, easing the transition of your model into production.</p><p>In this post, I will describe a good way to manage the hyperparameters using Tensorflow’s <code>HParams</code> and <a href="https://en.wikipedia.org/wiki/YAML" target="_blank" rel="noopener">YAML</a>, which enjoys the following advantages:</p><ul><li>human-readable configuration</li><li>allow multiple environments/contexts</li><li>easy to maintain and extend</li><li>light in terms of code</li></ul><h2><span id="what-is-yaml-and-why-not-json">What is YAML and Why not JSON?</span></h2><p><a href="http://yaml.org/" target="_blank" rel="noopener">YAML</a> is a human friendly data serialization standard for all programming languages. The following code shows an example of a YAML file:<br></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">default:</span> <span class="meta">&amp;DEFAULT</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">split_ratio:</span> <span class="number">0.9</span>  <span class="comment"># training/validation ratio</span></span><br><span class="line">  <span class="attr">train_embedding:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">cell:</span> <span class="string">sru</span>  <span class="comment"># simplified recursion unit</span></span><br><span class="line">  <span class="attr">init_state_type:</span> <span class="string">var</span></span><br><span class="line">  <span class="attr">dilation:</span> <span class="string">[1,</span> <span class="number">2</span><span class="string">,</span> <span class="number">4</span><span class="string">,</span> <span class="number">8</span><span class="string">,</span> <span class="number">16</span><span class="string">,</span> <span class="number">32</span><span class="string">]</span></span><br><span class="line">  <span class="attr">num_hidden:</span> <span class="number">128</span></span><br><span class="line">  <span class="attr">metric:</span> <span class="string">cosine</span></span><br><span class="line">  <span class="attr">num_epoch:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">optimizer:</span> <span class="string">rmsp</span></span><br><span class="line">  <span class="attr">learning_rate:</span> <span class="number">1.0e-4</span></span><br><span class="line">  <span class="attr">decay_rate:</span> <span class="number">0.97</span></span><br><span class="line">  <span class="attr">test_interval:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">loss:</span> <span class="string">logisitc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">large_hidden:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*DEFAULT</span></span><br><span class="line">  <span class="attr">num_hidden:</span> <span class="number">1024</span></span><br></pre></td></tr></table></figure><p></p><p>In this example, I defined two sets of parameters, i.e. <code>default</code> and <code>large_hidden</code>. An immediate observation is that this file is visually easier to look at than its JSON counterpart, which is usually surrounded by lots of double quotes and braces. Besides, YAML does support comments. This definitely helps others to understand the meaning of your parameters better. Yet most importantly, YAML has the ability to reference other items within a YAML file using “anchors”. By specifying <code>default</code> with <code>&amp;DEFAULT</code> anchor, <code>large_hidden</code> can be simply built by inserting all the key-value pairs from <code>default</code> to it (via <code>&lt;&lt;: *DEFAULT</code>), and then override the value of <code>num_hidden</code>. This is particularly useful as you can change few parameters without duplicating the entire parameter list. It is also more friendly to <code>git-diff</code>.</p><h2><span id="load-yaml-into-hparams">Load YAML into <code>HParams</code></span></h2><p>To use YAML configs in your python code, we need the class <code>HParams</code> defined in Tensorflow 1.4 API. A <code>HParams</code> object holds hyperparameters used to build and train a model, such as the number of hidden units in a neural net layer or the learning rate to use when training. It is very easy to use as you can directly access a parameter as a class attribute. For example:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hparams = HParams(learning_rate=<span class="number">0.1</span>, num_hidden_units=<span class="number">100</span>)</span><br><span class="line">print(hparams.learning_rate)  <span class="comment"># print 0.1</span></span><br></pre></td></tr></table></figure><p></p><p>To load our YAML configuration into <code>HParams</code>, we need a <a href="https://pypi.python.org/pypi/ruamel.yaml" target="_blank" rel="noopener">YAML parser</a> and wrap it as follows:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ruamel.yaml <span class="keyword">import</span> YAML</span><br><span class="line"><span class="keyword">from</span> tensorflow.contrib.training <span class="keyword">import</span> HParams</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YParams</span><span class="params">(HParams)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, yaml_fn, config_name)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        <span class="keyword">with</span> open(yaml_fn) <span class="keyword">as</span> fp:</span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> YAML().load(fp)[config_name].items():</span><br><span class="line">                self.add_hparam(k, v)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    hparams = YParams(<span class="string">'params.yaml'</span>, <span class="string">'large_hidden'</span>)</span><br><span class="line">    print(hparams.num_hidden)  <span class="comment"># print 1024</span></span><br></pre></td></tr></table></figure><p></p><p>And it’s done!</p><h2><span id="best-practice-separating-hyperparameters-and-app-configs">Best Practice: Separating Hyperparameters and App Configs</span></h2><p>Although we can use one YAML to store hyperparameters and app configurations together, I don’t recommend to do so. App configuration specifies the environment setups, resources paths and security, which mostly are from engineering aspects. Separating these two also enables us to automatically search for the best hyperparameters using other ML libraries. Here is an example of an app config:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">local:</span> <span class="meta">&amp;DEFAULT</span></span><br><span class="line">  <span class="attr">work_dir:</span> <span class="string">/Users/hxiao/Documents/</span></span><br><span class="line">  <span class="attr">instance:</span> <span class="string">p2.large</span>   <span class="comment"># gpu instance with K80</span></span><br><span class="line">  <span class="attr">spot_price:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">input_file:</span> <span class="string">data/db.2017-*-*.json.gz</span></span><br><span class="line">  <span class="attr">parameter_file:</span> <span class="string">params.yaml</span></span><br><span class="line">  <span class="attr">parameter_config:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">log_format:</span> <span class="string">'%(asctime)s:%(filename)s:%(funcName)s:[%(levelname)s] %(message)s'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debug:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*DEFAULT</span></span><br><span class="line">  <span class="attr">input_file:</span> <span class="string">data/db.2017-12-*.json.gz</span>  <span class="comment"># a smaller file for quick test</span></span><br><span class="line">  <span class="attr">parameter_config:</span> <span class="string">lstm_large</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*DEFAULT</span></span><br><span class="line">  <span class="attr">instance:</span> <span class="string">m4.xlarge</span>  <span class="comment"># cpu instance 4CPU, 16GB </span></span><br><span class="line">  <span class="attr">spot_price:</span> <span class="number">0</span>  <span class="comment"># reserved instance</span></span><br><span class="line">  <span class="attr">work_dir:</span> <span class="string">/opt/workspace/</span></span><br></pre></td></tr></table></figure><p>To load app config and hyperparameters in one-shot, simply use <code>YParams</code> from above:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelParams</span><span class="params">(YParams)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span><span class="params">(YParams)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, yaml_fn, config_name)</span>:</span></span><br><span class="line">        super().__init__(yaml_fn, config_name)</span><br><span class="line">        self.model_parameter = ModelParams(self.parameter_file, self.parameter_profile)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    config = AppConfig(<span class="string">'app.yaml'</span>, <span class="string">'local'</span>)</span><br><span class="line">    print(config.work_dir)  <span class="comment"># /Users/hxiao/Documents/</span></span><br><span class="line">    print(config.model_parameter.num_hidden)  <span class="comment"># 128</span></span><br></pre></td></tr></table></figure><p></p><p>If you are using <a href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator" target="_blank" rel="noopener">Estimator API</a> in Tensorflow 1.4, then importing these configs into the model becomes fairly easy. Simply use the following code:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(argv)</span>:</span></span><br><span class="line">    config = AppConfig(<span class="string">'config.yaml'</span>, argv[<span class="number">1</span>])  <span class="comment"># argv[1] is the profile of configs</span></span><br><span class="line">    params = ModelParams(<span class="string">'params.yaml'</span>, argv[<span class="number">2</span>])  <span class="comment"># argv[2] is the profile of params</span></span><br><span class="line">    model = tf.estimator.Estimator(model_fn=nade.model_fn, params=params)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    tf.app.run()</span><br></pre></td></tr></table></figure><p></p><p>A complete example using configs, Estimator and Dataset API can be found on <a href="https://github.com/hanxiao/tf-best-practice" target="_blank" rel="noopener">my Github repo</a>.</p><h2><span id="summary">Summary</span></h2><p>Having a good practice of managing configs and hyperparameters boosts the exploration-exploitation process when building a machine learning system. For example, I always store the evaluation results of each model in Line-delimited JSON (JSONL), and later visualize them in an interactive chart/table, e.g. check out the <a href="http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/" target="_blank" rel="noopener">benchmark page</a> of <a href="https://github.com/zalandoresearch/fashion-mnist" target="_blank" rel="noopener">Fashion-MNIST</a>.<br><img src="/2017/12/21/Use-HParams-and-YAML-to-Better-Manage-Hyperparameters-in-Tensorflow/85ddf919.png"></p><p>Finally, separating app configs from hyperparameters improves the collaboration between engineers and scientists in your team, easing the transition of a ML model into production.</p></div></article></div></main><footer><div class="paginator"><a href="/2018/01/10/Build-Cross-Lingual-End-to-End-Product-Search-using-Tensorflow/" class="prev">&nbsp;❮&nbsp;&nbsp;Building Cross-Lingu...</a><a href="/2017/11/08/Optimizing-Contrastive-Rank-Triplet-Loss-in-Tensorflow-for-Neural/" class="next">Optimizing Contrasti...&nbsp;&nbsp;❯&nbsp;</a></div><div id="gitment_thread"></div><div class="copyright"><p>© 2017 - 2020 <a href="https://hanxiao.io">Han Xiao</a>. Opinions are solely my own. <img src="/by-nc-sa.svg" alt="Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License." class="image"></p></div></footer></div><link rel="stylesheet" href="/css/post/katex.min.css"><link rel="stylesheet" href="/css/post/gitment.css"><script src="/js/katex.min.js"></script><script src="/js/auto-render.min.js"></script><script>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})</script><script src="/js/gitment.browser.js"></script><script src="/js/gitment.loader.js"></script><script src="/js/jquery-3.4.1.min.js"></script><script src="/js/reading_progress.min.js"></script><script async src="https://www.google-analytics.com/analytics.js"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-52114253-1","auto"),ga("send","pageview")</script></body></html>