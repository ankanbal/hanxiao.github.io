<!DOCTYPE html><html lang="en"><style>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,header,main{display:block}a{background-color:transparent}h1{font-size:2em;margin:.67em 0}img{border:0}body,html{width:100%;height:100%}body{margin:0;color:#34495e;font-size:18px;line-height:1.6;background-color:#fff;font-family:sourcesanspro,'Helvetica Neue',Arial,sans-serif}ul.nav{margin:0;padding:0;list-style-type:none}ul{margin:1rem 0}a{color:#2c3e50;text-decoration:none}.flag-icon{height:25px;width:25px;display:inline;border-radius:50%;vertical-align:sub}.icon_item{padding-left:5px!important;padding-right:5px!important}header{min-height:60px}header .logo-link{float:left}header .nav{float:right;left:80px}header .logo-link img{height:60px}header .nav-list-item{display:inline-block;padding:19px 10px}header .nav-list-item a{line-height:1.4}@media screen and (max-width:900px){header .nav-list-item a{font-size:15px}}@media screen and (min-width:900px){header .nav-list-item a{font-size:18px}}.post{padding-top:1em}.post-block .post-title{margin:.65em 0;color:#2c3e50;font-size:1.5em}.post-block .post-info{color:#7f8c8d}.post-block .post-info .read-time{text-align:right}.post-content h2,.post-content h4{position:relative;margin:1em 0}.post-content h2 :before,.post-content h4 :before{content:"#";color:#42b983;position:absolute;left:-.7em;top:-4px;font-size:1.2em;font-weight:700}.post-content h4 :before{content:">"}.post-content h2{font-size:22px}.post-content h4{font-size:18px}.post-content a{color:#42b983;word-break:break-all}main.container{margin:2em 10px}@media screen and (min-width:900px){.wrap{width:900px;margin:0 auto}header{padding:20px 60px}}@media screen and (max-width:900px){.wrap{width:100%}header{min-height:50px;padding:2px 2px;position:fixed;z-index:10000;border-radius:15px;left:50%;-webkit-transform:translateX(-50%);transform:translateX(-50%);width:-webkit-fit-content;width:-moz-fit-content;width:fit-content}header a.logo-link,header ul.nav.nav-list{float:none;display:inline;text-align:center}header li.nav-list-item{padding:10px 5px}header .logo-link img{height:20px;vertical-align:sub}header .flag-icon{height:20px;width:20px}header{background-color:rgba(255,255,255,.9)}@supports ((-webkit-backdrop-filter:blur(2em)) or (backdrop-filter:blur(2em))){header{background-color:rgba(255,255,255,.3);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}}main.container{padding-top:2em}main.container{margin:0 20px}.post-content h2,.post-content h4{max-width:300px;left:15px}}@font-face{font-family:sourcesanspro;src:url(/font/sourcesanspro.woff2) format("woff2"),url(/font/sourcesanspro.woff) format("woff");font-weight:400;font-style:normal}</style><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>New Features in Jina v0.5 You Should Know About ¬∑ Han Xiao Tech Blog - Neural Search, AI, Engineering</title><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@hxiao"><meta name="twitter:creator" content="@hxiao"><meta name="description" content="Today we are excited to release Jina v0.5.0. Jina is an easier way for enterprises and developers to build neural search in the cloud. The new version ... ¬∑ Han Xiao"><meta property="og:title" content="New Features in Jina v0.5 You Should Know About ¬∑ Han Xiao Tech Blog - Neural Search, AI, Engineering"><meta property="og:description" content="Today we are excited to release Jina v0.5.0. Jina is an easier way for enterprises and developers to build neural search in the cloud. The new version ... ¬∑ Han Xiao"><meta property="og:url" content="https://hanxiao.io/2020/08/28/What-s-New-in-Jina-v0-5/"><meta property="og:image" content="https://hanxiao.io/2020/08/28/What-s-New-in-Jina-v0-5//blog-post-v050-banner.jpg"><meta property="og:type" content="article"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/wechaticon.png"><link rel="alternate" type="application/rss+xml" title="Han Xiao Tech Blog - Neural Search, AI, Engineering" href="https://hanxiao.io/atom.xml"><link rel="preload" href="/css/apollo.css" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="/css/apollo.css"></noscript><script>!function(n){"use strict";n.loadCSS||(n.loadCSS=function(){});var o=loadCSS.relpreload={};if(o.support=function(){var e;try{e=n.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),o.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},o.poly=function(){if(!o.support())for(var t=n.document.getElementsByTagName("link"),e=0;e<t.length;e++){var a=t[e];"preload"!==a.rel||"style"!==a.getAttribute("as")||a.getAttribute("data-loadcss")||(a.setAttribute("data-loadcss",!0),o.bindMediaToggle(a))}},!o.support()){o.poly();var t=n.setInterval(o.poly,500);n.addEventListener?n.addEventListener("load",function(){o.poly(),n.clearInterval(t)}):n.attachEvent&&n.attachEvent("onload",function(){o.poly(),n.clearInterval(t)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:n.loadCSS=loadCSS}("undefined"!=typeof global?global:this)</script><link rel="search" type="application/opensearchdescription+xml" href="https://hanxiao.io/atom.xml" title="Han Xiao Tech Blog - Neural Search, AI, Engineering"></head><body><div class="reading-progress-bar"></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/wechaticon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/subscribe/" target="_self" class="nav-list-link">SUBSCRIBE</a></li><li class="nav-list-item icon_item"><a href="https://www.linkedin.com/in/hxiao87" target="_blank" class="nav-list-link"><img src="/linkedin.svg" alt="linkedin" class="flag-icon"></a></li><li class="nav-list-item icon_item"><a href="https://twitter.com/hxiao" target="_blank" class="nav-list-link"><img src="/twitter.svg" alt="twitter" class="flag-icon"></a></li><li class="nav-list-item icon_item"><a href="https://github.com/hanxiao" target="_blank" class="nav-list-link"><img src="/github.svg" alt="github" class="flag-icon"></a></li><li class="nav-list-item icon_item"><a href="https://www.youtube.com/c/jina-ai" target="_blank" class="nav-list-link"><img src="/youtube.svg" alt="youtube" class="flag-icon"></a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">New Features in Jina <code>v0.5</code> You Should Know About</h1><div class="post-info">Aug 28, 2020 by &nbsp;&nbsp;&nbsp;<img src="/myavatar.png" alt="logo" width="18px" height="18px" style="vertical-align:sub">&nbsp;<a href="https://www.linkedin.com/company/jinaai" target="_blank" class="nav-list-link">Han Xiao - Founder & CEO @ Jina AI üëê<i style="font-size:smaller"> We are hiring!</i></a></div><div class="post-info"><div class="read-time">‚ó∑&nbsp;&nbsp;&nbsp; 16 min read</div></div><div class="post-content"><h2><span id="background">Background</span></h2><p>Today we are excited to release Jina <code>v0.5.0</code>. <a href="https://github.com/jina-ai/jina/" target="_blank" rel="noopener">Jina is an easier way for enterprises and developers to build neural search in the cloud</a>. The new version is a great accomplishment made by our engineers and the open-source community: it contains 700 new commits covering 400 files and <strong>7000 lines</strong> of code since <code>v0.4.0</code>. The new release also introduces breaking changes and advanced features such as recursive document representation, query language driver, and hub rebuild.<a id="more"></a> In this post, I will go through some of the highlight features we have made on <code>v0.5.0</code> and explain the rationale behind them.</p><h4><span id="table-of-contents">Table of Contents</span></h4><ul><li><a href="#recursive-document-representation">Recursive Document Representation</a><ul><li><a href="#recursive-drivers-work-as-convolutiondeconvolution">Recursive Drivers Work as Convolution/Deconvolution</a></li><li><a href="#hello-world-after-refactoring">Hello-World after Refactoring</a></li></ul></li><li><a href="#new-query-language-driver">New Query Language Driver</a><ul><li><a href="#retrospect-query-language-from-scratch">Retrospect: Query Language From Scratch</a></li></ul></li><li><a href="#hub-as-a-git-submodule">Hub as a Git Submodule</a><ul><li><a href="#centralized-vs-decentralized-jina-hub">Centralized vs. Decentralized Jina Hub</a></li></ul></li><li><a href="#summary">Summary</a></li></ul><h2><span id="recursive-document-representation">Recursive Document Representation</span></h2><p>In Jina, <code>Document</code> is anything you want to search for. Engineering-wise, <code>Document</code> is a first-class structure defined by Protobuf. On the high-level, the Flow ingests <code>Document</code> for indexing, searching, training and evaluating; on the low-level, the driver reads and modifies <code>Document</code> or passes it to another driver. Besides the general properties such as <code>id</code>, <code>length</code>, <code>weight</code>, what makes <code>Document</code> interesting is that each <code>Document</code> contains a list of <code>Chunk</code>. The <code>Chunk</code> is a small semantic unit of a <code>Document</code>, like a sentence or a 64x64 pixel image patch. Most of the algorithms in Jina works on the <code>Chunk</code> level, the results are aggregated back to <code>ScoredResult</code> (which wraps a <code>Document</code> structure) before returning to the user. Before <code>v0.4.1</code>, <code>Chunk</code> and <code>ScoredResult</code> have their own Protobuf specification, though they share many common attributes.</p><p>In <code>v0.5.0</code>, we unify the Protobuf definition of <code>Document</code>, <code>Chunk</code> and <code>ScoredResult</code>. This dramatically simplifies the overall interface.</p><table><thead><tr><th>Before</th><th><code>v0.5.0</code></th></tr></thead><tbody><tr><td><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Document</span> </span>&#123;</span><br><span class="line">    <span class="built_in">uint32</span> doc_id = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">repeated</span> Chunk chunks = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">repeated</span> ScoredResult topk_results = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// more properties</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Chunk</span> </span>&#123;</span><br><span class="line">    <span class="built_in">uint32</span> doc_id = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">uint32</span> chunk_id = <span class="number">2</span>;</span><br><span class="line">    NdArray embedding = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">repeated</span> ScoredResult topk_results = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// more properties</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">ScoredResult</span> </span>&#123;</span><br><span class="line">    <span class="keyword">oneof</span> body &#123;</span><br><span class="line">        Chunk match_chunk = <span class="number">1</span>;</span><br><span class="line">        Document match_doc = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Score score = <span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// more properties</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></td><td><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Document</span> </span>&#123;</span><br><span class="line">    <span class="built_in">uint32</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">uint32</span> level_depth = <span class="number">14</span>;</span><br><span class="line">    <span class="keyword">repeated</span> Document chunks = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">repeated</span> Document matches = <span class="number">8</span>;</span><br><span class="line">    NdArray embedding = <span class="number">6</span>;</span><br><span class="line">    <span class="comment">// more properties</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></td></tr></tbody></table><p>One immediate consequence is that <code>Document</code> now has a recursive structure with arbitrary width and depth instead of a trivial bi-level structure. Roughly speaking, <code>chunks</code> can have the next level <code>chunks</code> and the same level <code>matches</code>; and so does <code>matches</code>. This could go on and on. The following figure illustrates this structure.</p><img src="/2020/08/28/What-s-New-in-Jina-v0-5/blog-post-v050-protobuf-documents.jpg" title="new Protobuf definition creates a recursive structure for documents"><p>This recursive structure allows <code>Document</code> to represent many real-world objects much comfortable than before. For example, in NLP a long document is composed of semantic chapters; each chapter consists of multiple paragraphs, which can be further segmented into sentences. In CV, a video is composed of one or more scenes, including one or more <em>shots</em> (i.e. a sequence of frames taken by a single camera over a continuous period time). Each shot includes one or more frames. Such hierarchical structures can be very well represented with this new Protobuf definition.</p><h4><span id="recursive-drivers-work-as-convolutiondeconvolution">Recursive Drivers Work as Convolution/Deconvolution</span></h4><p>With a low-level change like that, one may expect massive work on refactoring the high-level implementation. In fact, the refactoring work is mostly concentrated on the <code>Driver</code> layer, leaving <code>Pea</code>, <code>Pod</code>, <code>Flow</code> untouched. I talked about <a href="/2020/08/02/Layer-of-Abstraction-when-Building-Tensorflow-for-Search/" title="the importance of having layered APIs for progressive abstraction in large framework design">the importance of having layered APIs for progressive abstraction in large framework design</a> in my earlier post. Feel free to read that post if you are interested.</p><p>Erasing the difference between <code>Document</code> and <code>Chunk</code> does now make <code>Executor</code> completely <em>‚ÄúProtobuf-agnostic‚Äù</em>, allowing one to implement <code>Executor</code> more consistently. For instance, our previous <code>ChunkSpecificExecutor</code>, <code>DocSpecificExecutor</code> can now be unified into one.</p><p>What is really interesting is the way that <code>Driver</code> works now. In <code>v0.5.0</code>, we add two essential attributes <code>depth_range</code> and <code>traverse_on</code> to the drivers, which allows them to follow the Document structure and work recursively. By default, all drivers work on the root level (i.e., <code>level_depth=0</code>) only. To enable the recursion on deeper/wider levels, one can simply specify <code>depth_range</code>. In the following example, <code>BaseKVIndexer</code> indexes all <code>Document</code> from level-0 and 1. One can also limit the operation to a specific level by setting <code>depth_range: [k, k]</code>.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!BaseKVIndexer</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">IndexRequest:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="type">!KVIndexDriver</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">depth_range:</span> <span class="string">[0,</span> <span class="number">2</span><span class="string">]</span></span><br></pre></td></tr></table></figure><p>Recursive segmentation becomes extremely simple. Say we want to segment a long document while keeping its hierarchical structure, the implementation could look like the following:</p><table><thead><tr><th><code>LongTextSegmenter</code></th><th><code>myseg.yml</code></th></tr></thead><tbody><tr><td><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> jina.executors.crafters <span class="keyword">import</span> BaseSegmenter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LongTextSegmenter</span><span class="params">(BaseSegmenter)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">craft</span><span class="params">(self, text: str, depth_level: int, *args, **kwargs)</span> -&gt; List[Dict]:</span></span><br><span class="line">        results, chunks = [], []</span><br><span class="line">        <span class="keyword">if</span> depth_level == <span class="number">0</span>:</span><br><span class="line">            results = seg_to_chapters(text)</span><br><span class="line">        <span class="keyword">elif</span> depth_level == <span class="number">1</span>:</span><br><span class="line">            results = seg_to_paragraphs(text)</span><br><span class="line">        <span class="keyword">elif</span> depth_level == <span class="number">2</span>:</span><br><span class="line">            results = seg_to_sentences(text)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> idx, s <span class="keyword">in</span> enumerate(results):</span><br><span class="line">            chunks.append(dict(text=s, offset=idx, weight=<span class="number">1.0</span>))</span><br><span class="line">        <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></td><td><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="type">!LongTextSegmenter</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">IndexRequest:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="type">!SegmentDriver</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">depth_range:</span> <span class="string">[0,</span> <span class="number">3</span><span class="string">]</span></span><br></pre></td></tr></table></figure></td></tr></tbody></table><p>The recursion can go both directions: deeper or shallower, depending on <a href="https://en.wikipedia.org/wiki/Tree_traversal#Pre-order_(NLR" target="_blank" rel="noopener">the preorder or postorder traversal</a>) that the driver follows. In the segmenting example above, <code>SegmentDriver</code> follows the preorder traversal: create segments first and then deep diving into them. On the contrary, <code>BaseRankDriver</code> works in another direction: we first have to collect matching scores at deeper level and then aggregate this info back to the root level. Readers who have a basic AI background may quickly realize this is quite similar to convolution and deconvolution operations in deep neural networks.</p><img src="/2020/08/28/What-s-New-in-Jina-v0-5/blog-post-v050-protobuf-convolution.jpg"><h4><span id="hello-world-after-refactoring">Hello-World after Refactoring</span></h4><p>To see how effective this structure is, let‚Äôs make a side-by-side comparison on the Flow YAML specification behind <code>jina hello world</code>. <strong>From 23 lines to 11 lines!</strong> Not bad at all!</p><table><thead><tr><th><code>v0.4.0</code></th><th><code>v0.5.0</code></th></tr></thead><tbody><tr><td><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!Flow</span></span><br><span class="line"><span class="attr">with:</span></span><br><span class="line">  <span class="attr">logserver:</span> <span class="string">$WITH_LOGSERVER</span></span><br><span class="line">  <span class="attr">compress_hwm:</span> <span class="number">1024</span></span><br><span class="line"><span class="attr">pods:</span></span><br><span class="line">  <span class="attr">chunk_seg:</span></span><br><span class="line">    <span class="attr">yaml_path:</span> <span class="string">$RESOURCE_DIR/helloworld.crafter.yml</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="string">$REPLICAS</span></span><br><span class="line">    <span class="attr">read_only:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">doc_idx:</span></span><br><span class="line">    <span class="attr">yaml_path:</span> <span class="string">$RESOURCE_DIR/helloworld.indexer.doc.yml</span></span><br><span class="line">  <span class="attr">encode:</span></span><br><span class="line">    <span class="attr">yaml_path:</span> <span class="string">$RESOURCE_DIR/helloworld.encoder.yml</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">chunk_seg</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="string">$REPLICAS</span></span><br><span class="line">  <span class="attr">chunk_idx:</span></span><br><span class="line">    <span class="attr">yaml_path:</span> <span class="string">$RESOURCE_DIR/helloworld.indexer.chunk.yml</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="string">$SHARDS</span></span><br><span class="line">    <span class="attr">separated_workspace:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">join_all:</span></span><br><span class="line">    <span class="attr">yaml_path:</span> <span class="string">_merge</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">[doc_idx,</span> <span class="string">chunk_idx]</span></span><br><span class="line">    <span class="attr">read_only:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></td><td><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!Flow</span></span><br><span class="line"><span class="attr">with:</span></span><br><span class="line">  <span class="attr">logserver:</span> <span class="string">$WITH_LOGSERVER</span></span><br><span class="line">  <span class="attr">compress_hwm:</span> <span class="number">1024</span></span><br><span class="line"><span class="attr">pods:</span></span><br><span class="line">  <span class="attr">encode:</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">$RESOURCE_DIR/helloworld.encoder.yml</span></span><br><span class="line">    <span class="attr">parallel:</span> <span class="string">$PARALLEL</span></span><br><span class="line">  <span class="attr">index:</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">$RESOURCE_DIR/helloworld.indexer.yml</span></span><br><span class="line">    <span class="attr">shards:</span> <span class="string">$SHARDS</span></span><br><span class="line">    <span class="attr">separated_workspace:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></td></tr></tbody></table><h2><span id="new-query-language-driver">New Query Language Driver</span></h2><p>In <code>v0.5.0</code>, we introduce <a href="https://github.com/jina-ai/jina/tree/master/jina/drivers" target="_blank" rel="noopener">a new set of <code>Driver</code></a> called <em>Query Language Driver</em>. It is designed for filtering the content of the request based on the condition defined in the YAML or the payload, so that the executor only works on the filtered request. Query language driver can also be used to route requests into different sub-flows based on the condition. In the example below, by equipping <code>FilterQL</code> driver to <code>IndexRequest</code>, <code>Mode2Encoder</code> will only work on <code>Document</code> whose <code>modality = mode2</code> and leave others untouched.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!Mode2Encoder</span></span><br><span class="line"><span class="attr">with:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">requests:</span></span><br><span class="line">  <span class="attr">on:</span></span><br><span class="line">    <span class="attr">IndexRequest:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="type">!FilterQL</span></span><br><span class="line">            <span class="attr">with:</span></span><br><span class="line">                <span class="attr">lookups:</span> <span class="string">&#123;modality:</span> <span class="string">mode2&#125;</span></span><br><span class="line">                <span class="attr">traverse_on:</span> <span class="string">[chunks]</span></span><br><span class="line">                <span class="attr">depth_range:</span> <span class="string">[1,</span> <span class="number">2</span><span class="string">]</span></span><br></pre></td></tr></table></figure><p>Besides setting the attributes in YAML, one can also override the attributes of a Query Language Driver by setting <code>request.queryset</code> in the Protobuf message. For example,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jina.flow <span class="keyword">import</span> Flow</span><br><span class="line"><span class="keyword">from</span> jina.proto <span class="keyword">import</span> jina_pb2</span><br><span class="line"> </span><br><span class="line">f = Flow().add(uses=<span class="string">'- !SliceQL | &#123;start: 0, end: 5&#125;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># without queryset, will output 0,1,2,3,4</span></span><br><span class="line"><span class="keyword">with</span> f:</span><br><span class="line">    f.index(random_docs(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># now mock a queryset and put into request.queryset</span></span><br><span class="line">qs = jina_pb2.QueryLang(name=<span class="string">'SliceQL'</span>, priority=<span class="number">1</span>)</span><br><span class="line">qs.parameters[<span class="string">'start'</span>] = <span class="number">1</span></span><br><span class="line">qs.parameters[<span class="string">'end'</span>] = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># with queryset, will output 1,2,3</span></span><br><span class="line"><span class="keyword">with</span> f:</span><br><span class="line">    f.index(random_docs(<span class="number">10</span>), queryset=qs)</span><br></pre></td></tr></table></figure><p>The following query language drivers have been implemented in <code>v0.5.0</code>:</p><table><thead><tr><th>Query Language Driver</th><th>Description</th><th>Common Name in other query language</th></tr></thead><tbody><tr><td><code>FilterQL</code></td><td>filter <code>Document</code> by its attributes</td><td><code>filter</code>/<code>where</code></td></tr><tr><td><code>SelectQL</code>, <code>SelectReqQL</code>, <code>ExcludeQL</code>, <code>ExcludeReqQL</code></td><td>select attributes to include in the results</td><td><code>select</code>/<code>exclude</code></td></tr><tr><td><code>SliceQL</code></td><td>take a part of the list of <code>Document</code></td><td><code>limit</code>/<code>take</code>/<code>slicing</code></td></tr><tr><td><code>SortQL</code></td><td>sort list of <code>Document</code> by some attribute</td><td><code>sort</code>/<code>order_by</code></td></tr><tr><td><code>ReverseQL</code></td><td>reverse the list of collections</td><td><code>reverse</code></td></tr></tbody></table><h4><span id="retrospect-query-language-from-scratch">Retrospect: Query Language From Scratch</span></h4><p>It is interesting to take a retrospect of how we end up here. Essentially, we need an in-memory ORM/SQL that supports expressions and clauses and allows users to compose advance queries. Though Python has built-in advanced comprehensions covering a big chunk of SQL already, it is not easy to define Python expressions in YAML or JSON. In the early version of Jina, I have tried to <a href="https://github.com/jina-ai/jina/pull/524" target="_blank" rel="noopener">leverage <code>eval()</code> and <code>compile()</code> in <code>Driver</code> to parse arbitrary Python expression</a>. It certainly accomplished the task itself but leaving a big security risk to the whole stack. It is not a fair exchange.</p><p>We also reviewed several open-source solutions that implement similar functionality, however, each has some limitation:</p><ul><li><a href="https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#fieldmask" target="_blank" rel="noopener">Protobuf <code>FieldMask</code></a>: can not select sub-fields in the <code>repeated</code> fields;</li><li><a href="https://docs.djangoproject.com/en/3.1/ref/models/querysets/" target="_blank" rel="noopener">QuerySet in Django</a>: add extra dependency <code>Django</code>, overkill;</li><li><a href="https://github.com/pythonql/pythonql" target="_blank" rel="noopener">pythonql</a>: can not parse query language from YAML/JSON;</li><li><a href="https://github.com/naiquevin/lookupy" target="_blank" rel="noopener">lookupy</a>: do not support nested structure in a list, not actively maintained;</li><li><a href="https://github.com/viralogic/py-enumerable" target="_blank" rel="noopener">py-enumerable</a>: designed to be LINQ in Python, can not parse query language from YAML/JSON;</li><li><a href="https://github.com/timtadh/pyflwor" target="_blank" rel="noopener">pyflwor</a>: a customized model view for the data, not actively maintained and BSD license;</li><li><a href="https://github.com/myyang/django-pb-model" target="_blank" rel="noopener">django-pb-model</a>: need to maintain two views (Protobuf and Django) of every <code>Message</code>/<code>Request</code> and frequently converting between them.</li></ul><p>In the end, we decided to implement the query language from scratch. There are two ways to implement it:</p><ol><li>Implement a single all-mighty <code>QueryLangDriver</code>, which handles complex language parsing internally.</li><li>Implement each query operator as an orthogonal <code>Driver</code>. The complex query language is realized by chaining small independent drivers together.</li></ol><p>While Option (1) looks like a cleaner solution, implementing a new query language is non-trivial. We likely have to create a new DSL and its parser. Frankly, <em>nobody likes DSL</em>. Option (2) is much easier to implement and to test. However, some complex syntax may not be realized, as the query language built in this way is always <a href="https://en.wikipedia.org/wiki/Fluent_interface" target="_blank" rel="noopener">fluent-style</a>.</p><p>Jina <code>v0.5.0</code> goes for the second option. We also leave an interface for the first option, see <a href="https://github.com/jina-ai/jina/blob/master/jina/drivers/querylang/__init__.py#L10" target="_blank" rel="noopener"><code>BaseQueryLangDriver</code></a>.</p><h2><span id="hub-as-a-git-submodule">Hub as a Git Submodule</span></h2><p>In <code>v0.5.0</code> all concrete <code>Executor</code> classes are moved to <a href="https://github.com/jina-ai/jina-hub/" target="_blank" rel="noopener">a separate repository <code>jina-ai/jina-hub</code></a>. The <code>jina-hub</code> repository is then used as a git submodule in <code>jina</code> repository under the folder <code>hub/</code>. Only abstract executors such as <code>BaseExecutor</code> are maintained in the <code>jina</code> repository under the folder <code>executors/</code>. We also clarify the file structure of a customized executor. Besides the Python code, the bundle should include <code>manifest.yml</code>, <code>Dockerfile</code>, tests, and <code>README.md</code>. Users can simply type <code>jina hub new</code> in the console to create a new executor from the template. The following figure illustrates this idea.</p><img src="/2020/08/28/What-s-New-in-Jina-v0-5/blog-post-v050-gitmodule.jpg" title="Hub is now a submodule of the core"><p>To list all executors, one can use <code>jina check</code>. As before, Hub executors can be used in the executor YAML,</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!BigTransferEncoder</span></span><br><span class="line"><span class="attr">with:</span></span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure><p>or in Python,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jina.hub.encoders.image.BigTransferEncoder <span class="keyword">import</span> BigTransferEncoder</span><br><span class="line"></span><br><span class="line">BigTransferEncoder().encoder(...)</span><br></pre></td></tr></table></figure><p>One can also build the executor into a Docker image via:<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jina hub build .</span><br></pre></td></tr></table></figure><p></p><p>and then use the image directly in Flow API<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f = Flow().add(uses=<span class="string">'jinahub/pod.encoder.BigTransferEncoder:0.0.2'</span>)</span><br></pre></td></tr></table></figure><p></p><p>In <code>v0.5.0</code>, unit test is required for all Hub executors. To enforce this rule, we add <code>pytest</code> into the bundle template and <code>Dockerfile</code>. The developer needs to implement the test case based on the given boilerplate. This ensures that every built image can be run out of the box. We wrap the Hub building logic into <a href="https://github.com/marketplace/actions/jina-hub-image-builder" target="_blank" rel="noopener">a Github action</a> and publish it in Github Marketplace, allowing people to use it in their own CI/CD workflows.</p><p>Decoupling Hub from the Jina main repository is crucial and must be done now. With the increasing size of the project, the border between the core and hub becomes very fuzzy to the community. In the last two months, we found that nearly all executors are committed to <code>jina/executors</code>. However, customized executors often require extra dependencies and specific running environment that are not available locally, which poses the hardship of testing them in a single run. Before <code>v0.5.0</code>, not all executors in <code>jina/executors</code> are well tested, and the code quality varies greatly. This refactoring sets the Jina Hub back on track and helps our engineers and community to scale better as the project grows.</p><h4><span id="centralized-vs-decentralized-jina-hub">Centralized vs. Decentralized Jina Hub</span></h4><p>Note that, committing to <code>jina-ai/jina-hub</code> repository is not the only way to contribute or use the Hub. One can also maintain executors in its own (private) repository by simply adding <a href="https://github.com/marketplace/actions/jina-hub-image-builder" target="_blank" rel="noopener">this Github action</a> to the CI/CD workflow. In other words, we provide both centralized and decentralized ways to use Hub. The following figure illustrates these two procedures.</p><img src="/2020/08/28/What-s-New-in-Jina-v0-5/blog-post-v050-decentralized.jpg" title="Centralized vs. Decentralized Jina Hub by using Github Action"><h2><span id="summary">Summary</span></h2><p>This post highlighted the three major updates in <code>v0.5.0</code>. Besides that, there are <a href="https://github.com/jina-ai/jina/releases/tag/" target="_blank" rel="noopener">hundreds of patches</a> about improving performance, scalability, and easy-to-use. While the project‚Äôs growth has introduced challenges, we feel very fortunate to have the open-source community on our side and keep the momentum going strong on the development of Jina. The number of contributors to Jina has increased to 49 by today. If you want to know more about our engineering roadmap and the rationale behind specific features, welcome to join <a href="/2020/08/28/What-s-New-in-Jina-v0-5/" title="our monthly Engineering All Hands in Public">our monthly Engineering All Hands in Public</a> via Zoom or Youtube live stream. If you want to join us as full-time AI/back-end engineers, we are more than welcome, and please send your CV to <a href="mailto:career@jina.ai" target="_blank" rel="noopener">career@jina.ai</a>. Let‚Äôs build the next neural search ecosystem together!</p></div></article></div></main><footer><div class="paginator"><a href="/2020/09/21/Numpy-Tricks-and-A-Strong-Baseline-for-Vector-Index/" class="prev">&nbsp;‚ùÆ&nbsp;&nbsp;Numpy Tricks and A S...</a><a href="/2020/08/06/Engineering-All-Hands-in-Public/" class="next">Engineering All Hand...&nbsp;&nbsp;‚ùØ&nbsp;</a></div><div id="gitment_thread"></div><div class="copyright"><p>¬© 2017 - 2020 <a href="https://hanxiao.io">Han Xiao</a>. Opinions are solely my own. <img src="/by-nc-sa.svg" alt="Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License." class="image"></p></div></footer></div><link rel="stylesheet" href="/css/post/katex.min.css"><link rel="stylesheet" href="/css/post/gitment.css"><script src="/js/katex.min.js"></script><script src="/js/auto-render.min.js"></script><script>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})</script><script src="/js/gitment.browser.js"></script><script src="/js/gitment.loader.js"></script><script src="/js/jquery-3.4.1.min.js"></script><script src="/js/reading_progress.min.js"></script><script async src="https://www.google-analytics.com/analytics.js"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-52114253-1","auto"),ga("send","pageview")</script></body></html>